apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.serviceAccount.name | default (printf "%s-sa" (include "matillion-agent.fullname" .)) }}
  namespace: {{ .Release.Namespace }}
  {{- if eq (include "matillion-agent.cloudProvider" .) "aws" }}
  {{- if not .Values.aws.local.enabled }}
  annotations:
    eks.amazonaws.com/role-arn: {{ required "serviceAccount.roleArn is required for AWS deployments when not using local credentials" .Values.serviceAccount.roleArn }}
  {{- end }}
  {{- else if eq (include "matillion-agent.cloudProvider" .) "azure" }}
  {{- if .Values.azure.workloadIdentity.enabled }}
  annotations:
    azure.workload.identity/client-id: {{ required "azure.workloadIdentity.clientId is required for Azure workload identity deployments" .Values.azure.workloadIdentity.clientId }}
  {{- end }}
  {{- end }}
  labels:
    {{- if and (eq (include "matillion-agent.cloudProvider" .) "azure") .Values.azure.workloadIdentity.enabled }}
    azure.workload.identity/use: "true"
    {{- end }}