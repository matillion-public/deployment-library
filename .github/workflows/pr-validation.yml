name: PR Validation

on:
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check for required files
      run: |
        # Check if PR modifies deployment files
        if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E "(deployment\.yaml|values\.yaml)"; then
          echo "✅ Deployment files modified"
          
          # Validate deployment template syntax
          if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep "deployment\.yaml"; then
            echo "Validating deployment template..."
            # Basic template syntax check
            grep -q "metricsExporter" agent/helm/agent/templates/deployment.yaml || {
              echo "❌ Missing metricsExporter configuration"
              exit 1
            }
          fi
          
          # Validate values.yaml structure
          if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep "values\.yaml"; then
            echo "Validating values.yaml structure..."
            grep -q "metricsExporter:" agent/helm/agent/values.yaml || {
              echo "❌ Missing metricsExporter configuration in values.yaml"
              exit 1
            }
          fi
        fi

    - name: Size check
      run: |
        echo "Repository size:"
        du -sh .
        
        echo "Large files (>1MB):"
        find . -size +1M -type f || echo "No large files found"

  conventional-commits:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install commitlint
      run: |
        npm install -g @commitlint/cli @commitlint/config-conventional

    - name: Create commitlint config
      run: |
        cat > commitlint.config.js << EOF
        module.exports = {
          extends: ['@commitlint/config-conventional'],
          rules: {
            'type-enum': [2, 'always', [
              'feat', 'fix', 'docs', 'style', 'refactor', 
              'test', 'chore', 'ci', 'build'
            ]],
            'subject-case': [0, 'never']
          }
        }
        EOF

    - name: Check conventional commits
      run: |
        # Get the commit range for PR
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          COMMIT_RANGE="origin/${{ github.base_ref }}..${{ github.event.pull_request.head.sha }}"
        else
          COMMIT_RANGE="${{ github.event.before }}..${{ github.sha }}"
        fi
        
        # Validate each commit in the range
        for commit in $(git rev-list $COMMIT_RANGE); do
          echo "Checking commit: $commit"
          git log --format="%s" -n 1 $commit | npx commitlint
        done