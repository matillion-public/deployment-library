name: Merge Gate

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  # This job serves as a gate that blocks merging until all tests pass
  merge-gate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      checks: read
      actions: read
    steps:
    - name: Wait for status checks
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const sha = context.payload.pull_request.head.sha;
          
          // Required workflow job names that must pass
          const requiredChecks = [
            'validate',
            'conventional-commits', 
            'python-tests',
            'helm-tests',
            'integration-tests',
            'helm-lint',
            'yaml-validation',
            'docker-security-scan',
            'helm-security-scan', 
            'secrets-scan',
            'dependency-scan'
          ];
          
          console.log(`Checking status of required checks for commit ${sha}...`);
          
          let allPassed = false;
          let attempts = 0;
          const maxAttempts = 60; // Wait up to 10 minutes
          
          while (!allPassed && attempts < maxAttempts) {
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner,
              repo, 
              ref: sha
            });
            
            const relevantChecks = checkRuns.check_runs.filter(check => 
              requiredChecks.includes(check.name)
            );
            
            const failed = relevantChecks.filter(check => 
              check.status === 'completed' && check.conclusion !== 'success'
            );
            
            const pending = relevantChecks.filter(check =>
              check.status !== 'completed'
            );
            
            console.log(`Found ${relevantChecks.length} relevant checks:`);
            relevantChecks.forEach(check => {
              console.log(`  - ${check.name}: ${check.status} (${check.conclusion || 'pending'})`);
            });
            
            if (failed.length > 0) {
              console.log(`❌ ${failed.length} check(s) failed:`);
              failed.forEach(check => console.log(`  - ${check.name}`));
              core.setFailed('Required checks failed - merge blocked');
              return;
            }
            
            if (pending.length === 0) {
              console.log('✅ All required checks passed - merge allowed');
              allPassed = true;
            } else {
              console.log(`⏳ Waiting for ${pending.length} check(s) to complete...`);
              await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
              attempts++;
            }
          }
          
          if (!allPassed) {
            core.setFailed('Timeout waiting for required checks to complete');
          }