name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Mondays

jobs:
  docker-security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -f agent/helm/image/Dockerfile.sidecar -t metrics-sidecar:test agent/helm/image/

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'metrics-sidecar:test'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      continue-on-error: true
      with:
        sarif_file: 'trivy-results.sarif'

  helm-security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.12.0'

    - name: Install Checkov
      run: pip install checkov

    - name: Template Helm charts
      run: |
        helm template test-agent agent/helm/agent/ > /tmp/rendered-agent.yaml
        helm template test-prometheus agent/helm/prometheus/ > /tmp/rendered-prometheus.yaml

    - name: Run Checkov on rendered templates
      run: |
        checkov -f /tmp/rendered-agent.yaml --framework kubernetes
        checkov -f /tmp/rendered-prometheus.yaml --framework kubernetes

  secrets-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install GitLeaks
      run: |
        wget -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
        tar -xzf gitleaks.tar.gz
        chmod +x gitleaks
        sudo mv gitleaks /usr/local/bin/

    - name: Run GitLeaks
      run: |
        gitleaks detect --source . --verbose

  dependency-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install pip-audit (alternative to Safety)
      run: pip install pip-audit

    - name: Check Python dependencies for vulnerabilities
      run: |
        # Use pip-audit as it doesn't require registration
        pip-audit --requirement agent/helm/image/requirements.txt